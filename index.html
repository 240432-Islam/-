<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Облачный чат</title>
<style>
body {
    font-family: "Inter", sans-serif;
    background: #f0f2f5;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin: 0;
}
.container {
    width: 100%;
    max-width: 500px;
    background: white;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}
h3 { margin-top:0; }
#usersContainer {
    display: flex; flex-wrap: wrap; gap: 10px;
}
.user-avatar {
    width: 60px; height: 60px; border-radius: 50%;
    cursor: pointer; border: 3px solid #007bff;
    transition: 0.2s; object-fit: cover;
}
.user-avatar:hover { transform: scale(1.1); border-color:#0056b3; }
#messages {
    max-height: 350px; overflow-y: auto; padding: 10px;
    background: #f7f7f7; border-radius:10px; margin-bottom:10px;
}
.message {
    margin-bottom:10px; padding:8px 12px; border-radius:15px;
    max-width:75%; word-wrap: break-word;
}
.message.you { background:#007bff; color:white; margin-left:auto; text-align:right; }
.message.them { background:#e4e6eb; color:#333; margin-right:auto; text-align:left; }
textarea { width: 100%; padding:10px; border-radius:8px; border:1px solid #ccc; resize:none; }
button { background:#007bff; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; margin-top:5px; width:100%; font-weight:600; }
button:hover { background:#0056b3; }
.logout-btn { background:#ff4757; margin-top:5px; width:auto; }
.logout-btn:hover { background:#d6304c; }
</style>
</head>
<body>

<!-- AUTH -->
<div class="container" style="text-align:center;">
    <button id="loginBtn">Войти через Google</button>
    <div id="userPanel" style="display:none;">
        <img id="userPhoto" src="" width="50" style="border-radius:50%">
        <b id="userName"></b>
        <button id="logoutBtn" class="logout-btn">Выйти</button>
    </div>
</div>

<!-- USERS LIST -->
<div id="userList" class="container" style="display:none;">
    <h3>Выберите пользователя для чата</h3>
    <div id="usersContainer"></div>
</div>

<!-- DM CHAT -->
<div id="dmChat" class="container" style="display:none;">
    <h3 id="chatWith"></h3>
    <div id="messages"></div>
    <textarea id="dmText" placeholder="Напишите сообщение..."></textarea>
    <button id="sendDmBtn">Отправить</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyA7XlW_nh-IVyKWbEQMiLxm0TzIilOYhwo",
    authDomain: "myproject-aabca.firebaseapp.com",
    projectId: "myproject-aabca",
    storageBucket: "myproject-aabca.firebasestorage.app",
    messagingSenderId: "685101721502",
    appId: "1:685101721502:web:36ec315ecab087b45f188f",
    measurementId: "G-S6ZRRY7MQF"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// DOM
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userPanel = document.getElementById("userPanel");
const userName = document.getElementById("userName");
const userPhoto = document.getElementById("userPhoto");

const usersContainer = document.getElementById("usersContainer");
const userList = document.getElementById("userList");

const dmChat = document.getElementById("dmChat");
const chatWith = document.getElementById("chatWith");
const messagesDiv = document.getElementById("messages");
const dmText = document.getElementById("dmText");
const sendDmBtn = document.getElementById("sendDmBtn");

let currentChatUser = null;

// AUTH
loginBtn.onclick = ()=>signInWithPopup(auth,provider);
logoutBtn.onclick = ()=>signOut(auth);

onAuthStateChanged(auth, async (user)=>{
    if(user){
        loginBtn.style.display="none";
        userPanel.style.display="flex";
        userPanel.style.alignItems="center";
        userName.textContent = user.displayName;
        userPhoto.src = user.photoURL;

        // save/update user
        await setDoc(doc(db,"users",user.uid),{
            uid:user.uid,
            name:user.displayName,
            email:user.email,
            photo:user.photoURL
        },{merge:true});

        userList.style.display="block";
        loadUsers();
    } else {
        loginBtn.style.display="block";
        userPanel.style.display="none";
        userList.style.display="none";
        dmChat.style.display="none";
    }
});

// LOAD USERS
function loadUsers(){
    const q = collection(db,"users");
    onSnapshot(q,snapshot=>{
        usersContainer.innerHTML="";
        snapshot.forEach(docSnap=>{
            const u = docSnap.data();
            if(u.uid===auth.currentUser.uid) return;
            const img = document.createElement("img");
            img.src = u.photo;
            img.className="user-avatar";
            img.title = u.name;
            img.onclick = ()=>openChat(u);
            usersContainer.appendChild(img);
        });
    });
}

// OPEN CHAT
function openChat(user){
    currentChatUser=user;
    dmChat.style.display="block";
    chatWith.textContent="Чат с "+user.name;
    loadMessages();
}

// LOAD MESSAGES
function loadMessages(){
    const q = query(collection(db,"private_messages"), orderBy("timestamp","asc"));
    onSnapshot(q,snapshot=>{
        messagesDiv.innerHTML="";
        snapshot.forEach(docSnap=>{
            const m = docSnap.data();
            if(!currentChatUser) return;
            if(m.participants.includes(auth.currentUser.uid) && m.participants.includes(currentChatUser.uid)){
                const div = document.createElement("div");
                div.className="message "+(m.fromUid===auth.currentUser.uid?"you":"them");
                div.textContent=m.text;
                messagesDiv.appendChild(div);
            }
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
}

// SEND MESSAGE
sendDmBtn.onclick=async ()=>{
    if(!currentChatUser) return;
    const text = dmText.value.trim();
    if(!text) return;
    await addDoc(collection(db,"private_messages"),{
        fromUid: auth.currentUser.uid,
        toUid: currentChatUser.uid,
        text: text,
        timestamp: serverTimestamp(),
        participants:[auth.currentUser.uid,currentChatUser.uid]
    });
    dmText.value="";
};
</script>
</body>
</html>
