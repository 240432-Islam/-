<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Облачное приложение с чатом</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f7f6;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin: 0;
}
.container {
    width: 100%;
    max-width: 500px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.post {
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
}
button {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
button:hover { background: #0056b3; }
.logout-btn { background: #ff4757; }
textarea, input { width: 100%; padding: 8px; margin-top: 8px; box-sizing: border-box; }
.user-avatar { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; margin: 3px; border: 2px solid #007bff; }
#usersContainer { display: flex; flex-wrap: wrap; }
#messages { max-height: 300px; overflow-y: auto; border:1px solid #eee; padding:5px; margin-bottom:5px; }
</style>
</head>
<body>

<!-- AUTH -->
<div class="container" style="text-align:center;">
    <button id="loginBtn">Войти через Google</button>
    <div id="userPanel" style="display:none;">
        <p><img id="userPhoto" src="" width="40" style="border-radius:50%"> <b id="userName"></b></p>
        <button id="logoutBtn" class="logout-btn">Выйти</button>
    </div>
</div>

<!-- POSTS -->
<div id="postSection" class="container" style="display:none;">
    <h3>Создать пост</h3>
    <textarea id="postText" placeholder="Введите текст..."></textarea>
    <button id="publishBtn">Опубликовать</button>
</div>
<div id="feed" class="container"></div>

<!-- USERS LIST -->
<div id="userList" class="container" style="display:none;">
    <h3>Пользователи</h3>
    <div id="usersContainer"></div>
</div>

<!-- DM CHAT -->
<div id="dmChat" class="container" style="display:none;">
    <h3 id="chatWith"></h3>
    <div id="messages"></div>
    <textarea id="dmText" placeholder="Написать сообщение..."></textarea>
    <button id="sendDmBtn">Отправить</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, updateDoc, doc, increment, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyA7XlW_nh-IVyKWbEQMiLxm0TzIilOYhwo",
    authDomain: "myproject-aabca.firebaseapp.com",
    projectId: "myproject-aabca",
    storageBucket: "myproject-aabca.firebasestorage.app",
    messagingSenderId: "685101721502",
    appId: "1:685101721502:web:36ec315ecab087b45f188f",
    measurementId: "G-S6ZRRY7MQF"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// DOM
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userPanel = document.getElementById("userPanel");
const userName = document.getElementById("userName");
const userPhoto = document.getElementById("userPhoto");

const postSection = document.getElementById("postSection");
const publishBtn = document.getElementById("publishBtn");
const postText = document.getElementById("postText");
const feed = document.getElementById("feed");

const usersContainer = document.getElementById("usersContainer");
const userList = document.getElementById("userList");

const dmChat = document.getElementById("dmChat");
const chatWith = document.getElementById("chatWith");
const messagesDiv = document.getElementById("messages");
const dmText = document.getElementById("dmText");
const sendDmBtn = document.getElementById("sendDmBtn");

let currentChatUser = null;

// AUTH
loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
    if(user){
        loginBtn.style.display = "none";
        userPanel.style.display = "block";
        postSection.style.display = "block";
        userList.style.display = "block";
        userName.textContent = user.displayName;
        userPhoto.src = user.photoURL;

        // сохраняем пользователя
        await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            name: user.displayName,
            email: user.email,
            photo: user.photoURL
        }, {merge:true});

        loadUsers();
        loadPosts();
    } else {
        loginBtn.style.display = "block";
        userPanel.style.display = "none";
        postSection.style.display = "none";
        userList.style.display = "none";
        dmChat.style.display = "none";
    }
});

// POSTS
publishBtn.onclick = async () => {
    const user = auth.currentUser;
    if(!postText.value.trim()) return;
    await addDoc(collection(db, "posts"), {
        name: user.displayName,
        uid: user.uid,
        text: postText.value,
        likes: 0,
        timestamp: serverTimestamp()
    });
    postText.value="";
};

function loadPosts(){
    const q = query(collection(db,"posts"), orderBy("timestamp","desc"));
    onSnapshot(q, snapshot=>{
        feed.innerHTML="<h3>Лента</h3>";
        snapshot.forEach(docSnap=>{
            const d = docSnap.data();
            const div = document.createElement("div");
            div.className="post";
            div.innerHTML=`<b>${d.name}</b><p>${d.text}</p>
            <button onclick="likePost('${docSnap.id}')">❤️ ${d.likes||0}</button>`;
            feed.appendChild(div);
        });
    });
}

window.likePost = async (id)=>{
    await updateDoc(doc(db,"posts",id),{likes: increment(1)});
};

// USERS LIST
function loadUsers(){
    onSnapshot(collection(db,"users"), snapshot=>{
        usersContainer.innerHTML="";
        snapshot.forEach(docSnap=>{
            const u = docSnap.data();
            if(u.uid===auth.currentUser.uid) return;
            const img = document.createElement("img");
            img.src=u.photo;
            img.className="user-avatar";
            img.title=u.name;
            img.onclick = ()=> openChat(u);
            usersContainer.appendChild(img);
        });
    });
}

// DM CHAT
function openChat(user){
    currentChatUser = user;
    dmChat.style.display="block";
    chatWith.textContent="Чат с "+user.name;
    loadMessages();
}

function loadMessages(){
    const q = query(collection(db,"private_messages"), orderBy("timestamp","asc"));
    onSnapshot(q, snapshot=>{
        messagesDiv.innerHTML="";
        snapshot.forEach(docSnap=>{
            const m = docSnap.data();
            if(!currentChatUser) return;
            if(m.participants.includes(currentChatUser.uid) && m.participants.includes(auth.currentUser.uid)){
                const div = document.createElement("div");
                div.innerHTML=`<b>${m.fromUid===auth.currentUser.uid?"Вы":currentChatUser.name}</b>: ${m.text}`;
                messagesDiv.appendChild(div);
            }
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
}

sendDmBtn.onclick=async ()=>{
    if(!currentChatUser) return;
    const text = dmText.value.trim();
    if(!text) return;
    await addDoc(collection(db,"private_messages"),{
        fromUid: auth.currentUser.uid,
        toUid: currentChatUser.uid,
        text: text,
        timestamp: serverTimestamp(),
        participants: [auth.currentUser.uid,currentChatUser.uid]
    });
    dmText.value="";
};
</script>
</body>
</html>
