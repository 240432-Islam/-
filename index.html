<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Облачное приложение с личным чатом</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f7f6;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin: 0;
}

.container {
    width: 100%;
    max-width: 500px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.post {
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
}

button {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}

button:hover {
    background: #0056b3;
}

.logout-btn {
    background: #ff4757;
}

textarea, input {
    width: 100%;
    padding: 8px;
    margin-top: 8px;
    box-sizing: border-box;
}

.time {
    font-size: 12px;
    color: gray;
}
</style>
</head>

<body>

<!-- AUTH -->
<div class="container" style="text-align:center;">
    <button id="loginBtn">Войти через Google</button>

    <div id="userPanel" style="display:none;">
        <p><b id="userName"></b></p>
        <button id="logoutBtn" class="logout-btn">Выйти</button>
    </div>
</div>

<!-- POSTS -->
<div id="postSection" class="container" style="display:none;">
    <h3>Создать пост</h3>
    <textarea id="postText" placeholder="Введите текст..."></textarea>
    <button id="publishBtn">Опубликовать</button>
</div>

<div id="feed" class="container"></div>

<!-- DM -->
<div id="dmSection" class="container" style="display:none;">
    <h3>Личные сообщения</h3>
    <input type="text" id="receiverUid" placeholder="UID получателя">
    <textarea id="dmText" placeholder="Введите сообщение"></textarea>
    <button id="sendDmBtn">Отправить</button>
</div>

<div id="dmFeed" class="container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { 
    getFirestore, collection, addDoc, query, orderBy, 
    onSnapshot, updateDoc, doc, increment, serverTimestamp, where 
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { 
    getAuth, signInWithPopup, GoogleAuthProvider, 
    signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

// --- КОНФИГ ФАЙРБЕЙС ---
const firebaseConfig = {
    apiKey: "AIzaSyA7XlW_nh-IVyKWbEQMiLxm0TzIilOYhwo",
    authDomain: "myproject-aabca.firebaseapp.com",
    projectId: "myproject-aabca",
    storageBucket: "myproject-aabca.firebasestorage.app",
    messagingSenderId: "685101721502",
    appId: "1:685101721502:web:36ec315ecab087b45f188f",
    measurementId: "G-S6ZRRY7MQF"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// --- DOM ---
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userPanel = document.getElementById("userPanel");
const userName = document.getElementById("userName");

const postSection = document.getElementById("postSection");
const publishBtn = document.getElementById("publishBtn");
const postText = document.getElementById("postText");
const feed = document.getElementById("feed");

const dmSection = document.getElementById("dmSection");
const sendDmBtn = document.getElementById("sendDmBtn");
const receiverUid = document.getElementById("receiverUid");
const dmText = document.getElementById("dmText");
const dmFeed = document.getElementById("dmFeed");

// --- AUTH ---
loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, (user) => {
    if (user) {
        loginBtn.style.display = "none";
        userPanel.style.display = "block";
        postSection.style.display = "block";
        dmSection.style.display = "block";
        userName.textContent = user.displayName;

        loadDM(user);
    } else {
        loginBtn.style.display = "block";
        userPanel.style.display = "none";
        postSection.style.display = "none";
        dmSection.style.display = "none";
    }
});

// --- POSTS ---
publishBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!postText.value.trim()) return;

    await addDoc(collection(db, "posts"), {
        name: user.displayName,
        uid: user.uid,
        text: postText.value,
        likes: 0,
        timestamp: serverTimestamp()
    });

    postText.value = "";
};

const postQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));

onSnapshot(postQuery, (snapshot) => {
    feed.innerHTML = "<h3>Лента</h3>";
    snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "post";

        div.innerHTML = `
            <b>${escapeHtml(data.name)}</b>
            <p>${escapeHtml(data.text)}</p>
            <button onclick="likePost('${docSnap.id}')">
                ❤️ ${data.likes || 0}
            </button>
        `;

        feed.appendChild(div);
    });
});

window.likePost = async (id) => {
    await updateDoc(doc(db, "posts", id), {
        likes: increment(1)
    });
};

// --- DM ---
sendDmBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!receiverUid.value.trim() || !dmText.value.trim()) return;

    await addDoc(collection(db, "private_messages"), {
        fromUid: user.uid,
        toUid: receiverUid.value,
        fromName: user.displayName,
        text: dmText.value,
        timestamp: serverTimestamp(),
        participants: [user.uid, receiverUid.value]
    });

    dmText.value = "";
};

function loadDM(user) {
    const q = query(
        collection(db, "private_messages"),
        where("participants", "array-contains", user.uid),
        orderBy("timestamp", "asc")
    );

    onSnapshot(q, (snapshot) => {
        dmFeed.innerHTML = "<h3>Мои сообщения</h3>";

        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const div = document.createElement("div");
            div.className = "post";

            div.innerHTML = `
                <b>${escapeHtml(data.fromName)}</b>: 
                ${escapeHtml(data.text)}
            `;

            dmFeed.appendChild(div);
        });
    });
}

function escapeHtml(text) {
    return text
        ?.replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
</script>
</body>
</html>
